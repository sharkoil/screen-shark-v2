<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Shark Test Suite</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-controls {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
        
        .test-controls h2 {
            margin-top: 0;
            color: #1976D2;
        }
        
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .test-btn {
            background: #2196F3;
        }
        
        .test-btn:hover {
            background: #1976D2;
        }
        
        .danger-btn {
            background: #f44336;
        }
        
        .danger-btn:hover {
            background: #d32f2f;
        }
        
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .test-elements {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .test-section {
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        .console-output {
            background: #1e1e1e;
            color: #f0f0f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-pass {
            background-color: #4CAF50;
        }
        
        .status-fail {
            background-color: #f44336;
        }
        
        .status-pending {
            background-color: #ff9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü¶à Screen Shark Extension - Automated Test Suite</h1>
        
        <div class="test-controls">
            <h2>Test Controls</h2>
            <p>This page automatically tests the Screen Shark extension fixes for:</p>
            <ul>
                <li>Event listener cleanup after session ends</li>
                <li>Session JSON file saving</li>
                <li>Single content script instance</li>
                <li>Permission validation</li>
                <li>Error handling</li>
            </ul>
            
            <button onclick="runTests()" class="test-btn">üß™ Run All Tests</button>
            <button onclick="runQuickTest()" class="test-btn">‚ö° Quick Test</button>
            <button onclick="clearResults()">üßπ Clear Results</button>
            <button onclick="exportResults()" class="test-btn">üìã Export Results</button>
        </div>
        
        <div class="test-elements">
            <div class="test-section">
                <h3>üîò Interactive Elements</h3>
                <button onclick="logAction('Button clicked')">Test Button</button>
                <button onclick="logAction('Secondary button clicked')">Secondary</button>
                <a href="#" onclick="logAction('Link clicked'); return false;">Test Link</a>
                <input type="text" placeholder="Test input" onchange="logAction('Input changed')">
                <select onchange="logAction('Select changed')">
                    <option>Option 1</option>
                    <option>Option 2</option>
                </select>
            </div>
            
            <div class="test-section">
                <h3>üìä Test Status</h3>
                <div id="testStatus">
                    <p>Click "Run All Tests" to start validation</p>
                </div>
            </div>
            
            <div class="test-section">
                <h3>üéõÔ∏è Debug Controls</h3>
                <button onclick="checkState()" class="test-btn">Check State</button>
                <button onclick="enableDebug()" class="test-btn">Enable Debug</button>
                <button onclick="forceCleanup()" class="danger-btn">Force Cleanup</button>
                <button onclick="showConsole()" class="test-btn">Show Console</button>
            </div>
            
            <div class="test-section">
                <h3>üìà Session Test</h3>
                <button onclick="startSession()" style="background: #4CAF50;">Start Session</button>
                <button onclick="stopSession()" style="background: #f44336;">Stop Session</button>
                <button onclick="testInteraction()">Test Interaction</button>
                <p id="sessionStatus">Session: Unknown</p>
            </div>
        </div>
        
        <div class="results" id="testResults">
            Test results will appear here...
        </div>
        
        <div class="console-output" id="consoleOutput" style="display: none;">
            Console output will appear here...
        </div>
    </div>

    <script src="test-suite.js"></script>
    <script>
        let testSuite = null;
        let consoleCapture = [];
        
        // Capture console for display
        const originalConsole = console.log;
        console.log = function(...args) {
            consoleCapture.push(new Date().toLocaleTimeString() + ': ' + args.join(' '));
            if (consoleCapture.length > 100) consoleCapture.shift();
            originalConsole.apply(console, args);
        };

        function updateResults(text) {
            document.getElementById('testResults').textContent = text;
        }

        function appendResults(text) {
            const results = document.getElementById('testResults');
            results.textContent += text + '\n';
            results.scrollTop = results.scrollHeight;
        }

        async function runTests() {
            updateResults('ü¶à Initializing Screen Shark Test Suite...\n');
            
            try {
                testSuite = new ScreenSharkTestSuite();
                const results = await testSuite.runAllTests();
                
                updateResults(`Test Suite Completed!
                
üìä Summary:
‚úÖ Passed: ${results.passed}
‚ùå Failed: ${results.failed}
üìù Total: ${results.total}

üìã Detailed Results:
${results.results.map(r => `${r.status === 'PASS' ? '‚úÖ' : '‚ùå'} ${r.name}`).join('\n')}

${results.failed === 0 ? 'üéâ All tests passed! Extension fixes are working correctly.' : '‚ö†Ô∏è Some tests failed. Check console for details.'}
                `);
                
                updateTestStatus(results);
                
            } catch (error) {
                updateResults(`‚ùå Test suite failed to run: ${error.message}`);
            }
        }

        async function runQuickTest() {
            updateResults('‚ö° Running quick validation...\n');
            
            try {
                // Quick checks
                const hasInstance = !!window.screenSharkInstance;
                const bgState = await chrome.runtime.sendMessage({ action: 'getState' });
                
                appendResults(`Content Script Instance: ${hasInstance ? '‚úÖ' : '‚ùå'}`);
                appendResults(`Background Connection: ${bgState ? '‚úÖ' : '‚ùå'}`);
                appendResults(`Session Active: ${bgState?.sessionActive ? 'üü¢' : 'üî¥'}`);
                
                if (hasInstance) {
                    const instance = window.screenSharkInstance;
                    appendResults(`Event Listeners: ${instance.clickHandler ? 'üü¢' : 'üî¥'}`);
                }
                
                appendResults('\n‚ö° Quick test completed');
                
            } catch (error) {
                appendResults(`‚ùå Quick test failed: ${error.message}`);
            }
        }

        function updateTestStatus(results) {
            const statusDiv = document.getElementById('testStatus');
            statusDiv.innerHTML = results.results.map(r => 
                `<div><span class="status-indicator status-${r.status === 'PASS' ? 'pass' : 'fail'}"></span>${r.name}</div>`
            ).join('');
        }

        function clearResults() {
            document.getElementById('testResults').textContent = 'Results cleared...';
            document.getElementById('testStatus').innerHTML = '<p>Ready for testing</p>';
        }

        function exportResults() {
            if (!testSuite) {
                alert('No test results to export. Run tests first.');
                return;
            }
            
            const report = testSuite.generateReport();
            const dataStr = JSON.stringify(report, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `screen-shark-test-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        async function checkState() {
            try {
                const bgState = await chrome.runtime.sendMessage({ action: 'getState' });
                const instance = window.screenSharkInstance;
                
                appendResults(`\nüîç Current State Check:
Background Session: ${bgState.sessionActive ? 'üü¢ Active' : 'üî¥ Inactive'}
Content Session: ${instance?.sessionActive ? 'üü¢ Active' : 'üî¥ Inactive'}
Click Handler: ${instance?.clickHandler ? 'üü¢ Present' : 'üî¥ Missing'}
Submit Handler: ${instance?.submitHandler ? 'üü¢ Present' : 'üî¥ Missing'}
Debug Mode: ${bgState.debugMode ? 'üü¢ On' : 'üî¥ Off'}
                `);
            } catch (error) {
                appendResults(`‚ùå State check failed: ${error.message}`);
            }
        }

        function enableDebug() {
            if (window.screenSharkInstance) {
                window.screenSharkInstance.debugMode = true;
                appendResults('üîß Debug mode enabled for content script');
            } else {
                appendResults('‚ùå No content script instance found');
            }
        }

        function forceCleanup() {
            if (window.screenSharkInstance) {
                window.screenSharkInstance.cleanup();
                appendResults('üßπ Forced cleanup completed');
            } else {
                appendResults('‚ùå No instance to cleanup');
            }
        }

        function showConsole() {
            const consoleDiv = document.getElementById('consoleOutput');
            consoleDiv.style.display = consoleDiv.style.display === 'none' ? 'block' : 'none';
            consoleDiv.textContent = consoleCapture.join('\n');
        }

        async function startSession() {
            try {
                await chrome.runtime.sendMessage({ action: 'toggleSession' });
                setTimeout(updateSessionStatus, 500);
                appendResults('‚ñ∂Ô∏è Session start requested');
            } catch (error) {
                appendResults(`‚ùå Failed to start session: ${error.message}`);
            }
        }

        async function stopSession() {
            try {
                await chrome.runtime.sendMessage({ action: 'toggleSession' });
                setTimeout(updateSessionStatus, 500);
                appendResults('‚èπÔ∏è Session stop requested');
            } catch (error) {
                appendResults(`‚ùå Failed to stop session: ${error.message}`);
            }
        }

        async function updateSessionStatus() {
            try {
                const bgState = await chrome.runtime.sendMessage({ action: 'getState' });
                document.getElementById('sessionStatus').textContent = 
                    `Session: ${bgState.sessionActive ? 'üü¢ Active' : 'üî¥ Inactive'}`;
            } catch (error) {
                document.getElementById('sessionStatus').textContent = 'Session: ‚ùå Error';
            }
        }

        function testInteraction() {
            // This should trigger screenshot if session is active, or be ignored if not
            logAction('Test interaction triggered');
        }

        function logAction(action) {
            appendResults(`üñ±Ô∏è ${action} at ${new Date().toLocaleTimeString()}`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateSessionStatus();
            appendResults('ü¶à Screen Shark Test Page loaded');
            appendResults('Click "Run All Tests" to validate the extension fixes');
        });
    </script>
</body>
</html>
